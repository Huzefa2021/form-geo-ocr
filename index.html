<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MCGM | Abandoned Vehicles â€“ Marshal Upload Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Inline favicon (no 404) -->
  <link rel="icon" type="image/svg+xml"
        href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="%230b5aa3"/><stop offset="1" stop-color="%23ff9933"/></linearGradient></defs><rect width="64" height="64" rx="12" fill="url(%23g)"/><circle cx="32" cy="32" r="16" fill="white" opacity=".9"/></svg>'>

  <!-- Preconnects -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --mcgm-blue:#0b5aa3; --mcgm-orange:#ff9933;
      --bg:#f5f7fb; --fg:#0d2438; --line:#dde6f1; --card:#ffffff;
      --ok:#198754; --warn:#f59e0b; --err:#dc3545;
      --radius:14px;
      --shadow-card: 0 6px 22px rgba(10,25,55,.10), 0 1px 0 rgba(10,25,55,.06);
      --shadow-img:  0 10px 24px rgba(0,0,0,.12);
      --shadow-hover:0 18px 40px rgba(16,38,74,.18);
      --shadow-float:0 12px 30px rgba(10,25,55,.22);
      --topbar-h: clamp(56px, 8vw, 72px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); background:var(--bg);
      font-family:"Roboto","Noto Sans Devanagari",system-ui,-apple-system,"Segoe UI",Arial,Helvetica,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      font-size: clamp(14px, 1.8vw, 16px);
    }
    a{color:var(--mcgm-blue); text-decoration:none}
    a:hover{text-decoration:underline}

    /* ===== Sticky Masthead ===== */
    .masthead{position:sticky; top:0; z-index:1000; background:#fff; box-shadow:var(--shadow-float); border-bottom:4px solid var(--mcgm-orange)}
    .topbar{background:var(--mcgm-blue); color:#fff}
    .topbar-inner{max-width:1180px; margin:0 auto; padding:0 16px; height:var(--topbar-h); display:flex; align-items:center; gap:12px}
    .topbar img{height:100%; width:auto}
    .brand-title{font-weight:700; font-size:clamp(16px,2.6vw,20px); line-height:1.15}
    .brand-sub{font-size:clamp(12px,2vw,14px); opacity:.92}
    .header-actions{margin-left:auto; display:flex; align-items:center; gap:12px}
    .btn-reset{padding:8px 12px; border-radius:8px; border:1px solid #cfe0f3; background:#f7fbff; color:#0c3963; cursor:pointer; font-weight:600}

    /* Crescendo badge */
    .partner-badge{
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.65);
      -webkit-backdrop-filter:saturate(120%) blur(2px);
      backdrop-filter:saturate(120%) blur(2px);
      padding:4px 8px; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,.18), 0 1px 0 rgba(255,255,255,.6) inset;
    }
    .partner-badge img{height:calc(var(--topbar-h) - 12px); max-height:68px; width:auto; display:block}

    /* Progress */
    .progress-strip{background:linear-gradient(180deg,#ffffff 0%, #f6f9ff 100%); border-top:1px solid #e7eef7; border-bottom:1px solid #e7eef7}
    .progress-inner{max-width:1180px; margin:0 auto; padding:10px 16px}
    .milestones{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#f4f8ff; color:#0c3963; font-size:clamp(12px,2vw,13px)}
    .chip .ico{position:relative; width:14px; height:14px; border-radius:50%}
    .chip.pending .ico{border:2px solid #b9c7d6; background:#fff}
    .chip.active{box-shadow:0 0 0 3px rgba(245,158,11,.18), 0 0 18px rgba(245,158,11,.35); border-color:#ffd166; background:#fff8eb}
    .chip.active .ico{border:2px solid #f59e0b; border-top-color:transparent; border-right-color:transparent; animation:spin 1s linear infinite; background:#fff}
    .chip.done{box-shadow:0 0 0 3px rgba(25,135,84,.18), 0 0 18px rgba(25,135,84,.35); border-color:#b9e8cc; background:#eefcf4}
    .chip.done .ico{background:#198754}
    .chip.done .ico::after{content:""; position:absolute; left:3px; top:1px; width:4px; height:8px; border-right:2px solid #fff; border-bottom:2px solid #fff; transform:rotate(45deg)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .bar{height:10px; border-radius:999px; background:#e9f1fb; border:1px solid var(--line); overflow:hidden; margin-top:8px}
    .bar-fill{height:100%; width:0%; background:linear-gradient(90deg,#ffbd59,#ffd166); transition:width .35s ease}
    .strip-row{display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:8px}
    .status{font-size:clamp(12px,2vw,13px)} .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .stage-times{font-size:12px; color:#3a5677}
    .cdn-pill{margin-left:auto; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; border:1px solid #cfe0f3; background:#f7fbff; color:#0c3963}
    .cdn-pill.ok{background:#eefcf4; border-color:#b9e8cc; color:#0f5132}
    .cdn-pill.err{background:#fff0f0; border-color:#f3c0c0; color:#842029}

    /* Crumbs */
    .crumbs{background:#eef4fb; border-bottom:1px solid var(--line)}
    .crumbs-inner{max-width:1180px; margin:0 auto; padding:8px 16px; font-size:clamp(12px,2vw,13px); color:#43648a}
    .crumbs-inner a{color:#2f5f9a}

    /* Layout */
    .wrap{max-width:1180px; margin:16px auto; padding:0 12px}
    .grid{display:grid; grid-template-columns:1fr; grid-template-areas:"image" "results"; gap:12px}
    @media (min-width:980px){.grid{grid-template-columns:430px 1fr; grid-template-areas:"image results"; gap:18px}}
    .col-image{grid-area:image} .col-results{grid-area:results}

    /* Cards */
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow-card)}
    .card .hdr{padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px}
    .card .hdr .title{font-weight:700; color:#143a63}
    .card .body{padding:12px}

    /* Dropzone */
    .drop{border:2px dashed #cfe0f3; border-radius:var(--radius); min-height:120px; display:grid; place-items:center; text-align:center; padding:18px; cursor:pointer; background:#fbfdff}
    .drop:hover{border-color:#9ec5ff; background:#f6fbff}
    .dz-title{font-weight:600; color:#133a62}
    .dz-hint{font-size:clamp(12px,2vw,13px); color:#5f7896}

    /* Photo areas */
    .photo-surface{background:linear-gradient(180deg,#ffffff 0%, #f7fbff 100%); border:1px solid var(--line); border-radius:12px; padding:10px; box-shadow:var(--shadow-img)}
    .overlay-container{position:relative; display:none}
    .preview{width:100%; height:auto; border-radius:10px; border:1px solid var(--line)}
    .preview-small{width:25%; max-width:25%; min-width:120px; height:auto; border-radius:10px; border:1px solid var(--line)}
    .overlay-scanner{position:absolute; top:0; left:0; right:0; height:20%; background:linear-gradient(to bottom, rgba(255,187,68,.55), rgba(255,187,68,0)); border-radius:10px; display:none; animation:scanMove 3s linear infinite; box-shadow:0 0 0 2px rgba(255,187,68,.35) inset, 0 8px 20px rgba(255,187,68,.25)}
    @keyframes scanMove{0%{top:0;}100%{top:100%;}}
    @media (prefers-reduced-motion:reduce){.overlay-scanner{animation:none} .bar-fill{transition:none}}

    /* Results (read-only) */
    .kv{display:grid; grid-template-columns:1fr; gap:6px; padding:10px 0; border-bottom:1px dashed #e4edf7}
    .kv:last-child{border-bottom:0}
    .k{font-weight:700; color:#0f3468}
    .v{font-family:ui-monospace,Menlo,Consolas,monospace; color:#1b3d62; word-break:break-word}
    @media (min-width:600px){.kv{grid-template-columns:200px 1fr}}

    /* Footer */
    .footer{margin-top:16px; background:#0a4a87; color:#e9f2fb; border-top:3px solid var(--mcgm-orange)}
    .footer-inner{max-width:1180px; margin:0 auto; padding:14px; font-size:clamp(12px,2vw,13px); text-align:center}
    .footer-inner a{color:#ffd166; font-weight:600}

    /* Modals */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:2000}
    .modal{background:#fff; color:#1b2b3c; border-radius:12px; max-width:560px; width:min(92%,560px); box-shadow:0 20px 60px rgba(0,0,0,.2); border:1px solid #e5eef7}
    .modal .m-hdr{padding:14px 16px; border-bottom:1px solid #eef3f9; font-weight:700}
    .modal .m-body{padding:14px 16px}
    .modal .m-actions{padding:12px 16px; border-top:1px solid #eef3f9; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    .btn{padding:10px 14px; border-radius:8px; border:1px solid #cfe0f3; background:#f7fbff; color:#0c3963; cursor:pointer; font-weight:600}
    .btn-danger{background:#ffe2e0; border-color:#f3b3ad; color:#8a1c13}
    .btn-primary{background:var(--mcgm-orange); border-color:var(--mcgm-orange); color:#422306}
  </style>

  <!-- Turf (spatial) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.2.0/turf.min.js"></script>

  <!-- Robust Tesseract loader: v5 jsDelivr -> v5 unpkg -> v4 jsDelivr (no x.map) -->
  <script>
    window.__OCR_CDNS__ = {
      v5_jsd: {
        label: "v5 (jsDelivr)",
        lib:  'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js',
        core: ['https://cdn.jsdelivr.net/npm/tesseract.js-core@5'],
        langs:['https://cdn.jsdelivr.net/npm/@tesseract.js-data']
      },
      v5_unp: {
        label: "v5 (unpkg)",
        lib:  'https://unpkg.com/tesseract.js@5/dist/tesseract.min.js',
        core: ['https://unpkg.com/tesseract.js-core@5'],
        langs:['https://unpkg.com/@tesseract.js-data']
      },
      v4_jsd: {
        label: "v4 (jsDelivr)",
        lib: 'https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js'
      }
    };

    (function loadTesseract(){
      const addScript = (src) => new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src + (src.includes('?') ? '&' : '?') + 'v=ok';
        s.onload = res; s.onerror = rej; document.head.appendChild(s);
      });
      const toArr = x => Array.isArray(x) ? x : [x];

      async function tryV5(cfg){
        await addScript(cfg.lib);
        window.__OCR_VERSION__ = cfg.label;
        if (window.Tesseract?.createWorker) {
          const _cw = Tesseract.createWorker;
          Tesseract.createWorker = function (opts = {}) {
            const o = {...opts};
            // DO NOT set workerPath to a file (prevents x.map on string)
            if (!o.corePath) o.corePath = cfg.core;
            if (!o.langPath) o.langPath = cfg.langs;
            o.corePath = toArr(o.corePath);
            o.langPath = toArr(o.langPath);
            if (o.logger) delete o.logger; // avoid DataCloneError
            return _cw.call(Tesseract, o);
          };
        }
        if (window.Tesseract?.recognize) {
          const _rec = Tesseract.recognize;
          Tesseract.recognize = function (img, langs='eng', opts={}) {
            const o = {...opts};
            if (!o.corePath) o.corePath = cfg.core;
            if (!o.langPath) o.langPath = cfg.langs;
            o.corePath = toArr(o.corePath);
            o.langPath = toArr(o.langPath);
            if (o.logger) delete o.logger;
            return _rec.call(Tesseract, img, langs, o);
          };
        }
        return cfg.label;
      }

      (async ()=>{
        const pill = document.getElementById('cdnPill');
        try {
          const label = await tryV5(window.__OCR_CDNS__.v5_jsd);
          pill.textContent = 'CDN: ' + label; pill.classList.add('ok');
        } catch {
          try {
            const label = await tryV5(window.__OCR_CDNS__.v5_unp);
            pill.textContent = 'CDN: ' + label; pill.classList.add('ok');
          } catch {
            try {
              await addScript(window.__OCR_CDNS__.v4_jsd.lib);
              window.__OCR_VERSION__ = window.__OCR_CDNS__.v4_jsd.label;
              pill.textContent = 'CDN: ' + window.__OCR_VERSION__ + ' (fallback)'; pill.classList.add('ok');
            } catch (e) {
              pill.textContent = 'CDN: unavailable'; pill.classList.add('err');
              console.error('Failed to load Tesseract from all CDNs', e);
            }
          }
        }
      })();

      window.__arr = toArr;
    })();
  </script>
</head>
<body>

  <!-- ===== HEADER ===== -->
  <div class="masthead">
    <div class="topbar">
      <div class="topbar-inner">
        <img src="https://www.mcgm.gov.in/com.mcgm.newframework/images/logo_V1.png" alt="BMC/MCGM">
        <div>
          <div class="brand-title">Municipal Corporation of Greater Mumbai</div>
          <div class="brand-sub">Abandoned Vehicles â€“ Identification &amp; Pre-Notice (Marshal Upload)</div>
        </div>
        <div class="header-actions">
          <button id="btnReset" class="btn-reset" title="Clear & restart">Reset</button>
          <div class="partner-badge" title="Crescendo Innovative Solutions LLP">
            <img src="./data/Crescendo%20Logo.png" alt="Crescendo Innovative Solutions LLP" loading="eager" decoding="async">
          </div>
        </div>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-strip">
      <div class="progress-inner">
        <div class="milestones">
          <div class="chip pending" id="ms1"><span class="ico"></span><span>Upload</span></div>
          <div class="chip pending" id="ms2"><span class="ico"></span><span>OCR</span></div>
          <div class="chip pending" id="ms3"><span class="ico"></span><span>Parse</span></div>
          <div class="chip pending" id="ms4"><span class="ico"></span><span>GeoJSON</span></div>
          <div class="chip pending" id="ms5"><span class="ico"></span><span>Review</span></div>
          <div class="chip pending" id="ms6"><span class="ico"></span><span>Redirect</span></div>
        </div>
        <div class="bar"><div id="bar" class="bar-fill"></div></div>
        <div class="strip-row">
          <div id="status" class="status">Initializingâ€¦</div>
          <div id="redirectNote" class="status" style="display:none"></div>
          <div id="cdnPill" class="cdn-pill">CDN: checkingâ€¦</div>
        </div>
        <div id="stageTimes" class="stage-times">Upload â€” 0.0s â€¢ OCR â€” 0.0s â€¢ Parse â€” 0.0s â€¢ GeoJSON â€” 0.0s â€¢ Review â€” 0.0s â€¢ Redirect â€” 0.0s</div>
      </div>
    </div>
  </div>

  <!-- Breadcrumbs -->
  <div class="crumbs"><div class="crumbs-inner"><a href="https://www.mcgm.gov.in" target="_blank" rel="noopener">Home</a> â€º Abandoned Vehicles â€º Marshal Upload</div></div>

  <!-- ===== MAIN ===== -->
  <div class="wrap">
    <div class="grid">
      <!-- Left: Image -->
      <div class="col-image">
        <div id="dropCard" class="card">
          <div class="hdr"><div class="title">Upload Photo</div></div>
          <div class="body">
            <div id="drop" class="drop" role="button" aria-label="Upload image">
              <div>
                <div class="dz-title">Tap to choose image</div>
                <div class="dz-hint">or drag & drop (JPG/PNG from GPS Map Camera)</div>
              </div>
            </div>
            <input id="file" type="file" accept="image/*" hidden>
          </div>
        </div>

        <div id="originalCard" class="card" style="display:none">
          <div class="hdr"><div class="title">Original Photo (25%)</div></div>
          <div class="body"><div class="photo-surface"><img id="originalImg" class="preview-small" alt="original photo"></div></div>
        </div>

        <div id="overlayCard" class="card" style="display:none">
          <div class="hdr"><div class="title">Cropped Overlay (GPS text)</div></div>
          <div class="body">
            <div class="photo-surface overlay-container" id="overlayWrap">
              <img id="overlayImg" class="preview" alt="cropped overlay">
              <div id="overlayScanner" class="overlay-scanner"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Results (read-only) -->
      <div class="col-results">
        <div class="card">
          <div class="hdr"><div class="title">Results</div></div>
          <div class="body" id="results"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== FOOTER ===== -->
  <div class="footer">
    <div class="footer-inner">
      Developed by <strong>Crescendo Innovative Solutions LLP</strong>. All rights reserved by <strong>Crescendo</strong> â€¢
      Admin: <strong>Huzefa Fakhruddin</strong> â€” <a href="mailto:Care@crescendoits.com">Care@crescendoits.com</a> â€¢
      &copy; 2025 Municipal Corporation of Greater Mumbai (MCGM) â€”
      <a href="https://www.mcgm.gov.in" target="_blank" rel="noopener">www.mcgm.gov.in</a>
      <div style="margin-top:6px;opacity:.9">Build: <span id="appVersion">v2025.08.17</span></div>
    </div>
  </div>

  <!-- ===== MODALS ===== -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="m-hdr" id="modalTitle">Outside MCGM Boundaries â€” Not allowed</div>
      <div class="m-body">The detected coordinates are not inside MCGM ward polygons. You cannot submit this entry.</div>
      <div class="m-actions">
        <button id="modalCancel" class="btn">Cancel</button>
        <button id="modalReset" class="btn btn-danger">Reset Session</button>
      </div>
    </div>
  </div>

  <div id="timeoutBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="timeoutTitle">
    <div class="modal">
      <div class="m-hdr m-err" id="timeoutTitle">Stage Timed Out</div>
      <div class="m-body" id="timeoutBody">
        A stage exceeded the maximum allowed time.<br/>
        <strong>Reason:</strong> network slowness, large image, or blocked resources.<br/><br/>
        <strong>Admin:</strong> Huzefa Fakhruddin â€” <a href="mailto:Care@crescendoits.com">Care@crescendoits.com</a>
      </div>
      <div class="m-actions">
        <button id="timeoutRetry" class="btn btn-primary">Retry</button>
        <button id="timeoutClose" class="btn">Close</button>
      </div>
    </div>
  </div>

<script>
/* ======= CONFIG ======= */
const FORM_ID="1FAIpQLSeo-xlOSxvG0IwtO5MkKaTJZNJkgTsmgZUw-FBsntFlNdRnCw";
const ENTRY={ // 0..5 mapping per your spec
  date:"entry.1911996449", time:"entry.1421115881",
  lon:"entry.113122688", lat:"entry.419288992",
  ward:"entry.1625337207", beat:"entry.1058310891",
  address:"entry.1188611077", police:"entry.1555105834"
};
const STAGE_LIMITS=[20000,90000,12000,15000,45000,20000]; // ms per stage

/* ======= Elements & State ======= */
const els={
  dropCard:document.getElementById('dropCard'), drop:document.getElementById('drop'), file:document.getElementById('file'),
  originalCard:document.getElementById('originalCard'), originalImg:document.getElementById('originalImg'),
  overlayCard:document.getElementById('overlayCard'), overlayWrap:document.getElementById('overlayWrap'),
  overlayImg:document.getElementById('overlayImg'), overlayScanner:document.getElementById('overlayScanner'),
  status:document.getElementById('status'), bar:document.getElementById('bar'), results:document.getElementById('results'),
  redirectNote:document.getElementById('redirectNote'), stageTimes:document.getElementById('stageTimes'),
  ms:[...document.querySelectorAll('.milestones .chip')],
  modalBackdrop:document.getElementById('modalBackdrop'), modalCancel:document.getElementById('modalCancel'), modalReset:document.getElementById('modalReset'),
  timeoutBackdrop:document.getElementById('timeoutBackdrop'), timeoutRetry:document.getElementById('timeoutRetry'), timeoutClose:document.getElementById('timeoutClose'),
  btnReset:document.getElementById('btnReset'), cdnPill:document.getElementById('cdnPill')
};
const state={
  activeRun:0, croppedUrl:"", outside:false, timedOut:false,
  data:{date:"",time:"",lat:"",lon:"",address:"",WARD:"",BEAT_NO:"",PS_NAME:""},
  gjIndex:{wards:null,beats:null,police:null},
  stageStart:Array(6).fill(null), stageElapsed:Array(6).fill(0), stageTimeouts:Array(6).fill(null), stageTicker:null,
  countdownTimer:null
};
const A = x => Array.isArray(x) ? x : [x];

/* ======= UI helpers ======= */
function setStatus(msg,cls){els.status.className='status '+(cls||''); els.status.textContent=msg;}
function kvRow(id,label,value){
  let row=document.getElementById(id);
  if(!row){ row=document.createElement('div'); row.className='kv'; row.id=id; row.innerHTML=`<div class="k">${label}</div><div class="v">â€”</div>`; els.results.appendChild(row); }
  if(value!==undefined && value!==null) row.querySelector('.v').textContent=String(value||'â€”');
}
function renderIncremental(){
  const d=state.data;
  kvRow('row-date','Date',d.date);
  kvRow('row-time','Time',d.time);
  kvRow('row-lat','Latitude',d.lat);
  kvRow('row-lon','Longitude',d.lon);
  kvRow('row-addr','Address',d.address);
  kvRow('row-ward','Ward',d.WARD);
  kvRow('row-beat','Beat No.',d.BEAT_NO);
  kvRow('row-ps','Police Station',d.PS_NAME);
}
function buildPrefillURL(){
  const p=new URLSearchParams({
    [ENTRY.date]:state.data.date||"", [ENTRY.time]:state.data.time||"",
    [ENTRY.lon]:state.data.lon||"",   [ENTRY.lat]:state.data.lat||"",
    [ENTRY.ward]:state.data.WARD||"", [ENTRY.beat]:state.data.BEAT_NO||"",
    [ENTRY.address]:state.data.address||"", [ENTRY.police]:state.data.PS_NAME||"",
    usp:"pp_url"
  });
  return `https://docs.google.com/forms/d/e/${FORM_ID}/viewform?${p.toString()}`;
}
function applyChips(i){
  els.ms.forEach((chip,idx)=>{
    chip.classList.remove('pending','active','done');
    if(idx<i) chip.classList.add('done'); else if(idx===i) chip.classList.add('active'); else chip.classList.add('pending');
  });
  els.bar.style.width = Math.max(0,Math.min(100,(i/5)*100))+'%';
}
function fmt(ms){return (ms>0&&isFinite(ms))?(ms/1000).toFixed(1)+'s':'0.0s';}
function currentStageIndex(){for(let i=0;i<6;i++){if(state.stageStart[i]!==null&&state.stageElapsed[i]===0) return i;} for(let i=5;i>=0;i--) if(state.stageElapsed[i]>0) return Math.min(i+1,5); return 0;}
function updateTimes(){
  const names=["Upload","OCR","Parse","GeoJSON","Review","Redirect"];
  els.stageTimes.textContent = names.map((n,i)=>{
    const running=state.stageStart[i]!==null&&i===currentStageIndex();
    const v=running?(Date.now()-state.stageStart[i]):state.stageElapsed[i];
    return `${n} â€” ${fmt(v)}`;
  }).join(' â€¢ ');
}
function startStage(i){
  if(state.timedOut) return;
  for(let k=0;k<i;k++){ if(state.stageStart[k]!==null && state.stageElapsed[k]===0) endStage(k); }
  state.stageStart[i]=Date.now(); applyChips(i);
  if(!state.stageTicker) state.stageTicker=setInterval(updateTimes,200);
  clearTimeout(state.stageTimeouts[i]);
  state.stageTimeouts[i]=setTimeout(()=>onStageTimeout(i), STAGE_LIMITS[i]);
}
function endStage(i){
  if(state.stageStart[i]!==null && state.stageElapsed[i]===0) state.stageElapsed[i]=Date.now()-state.stageStart[i];
  clearTimeout(state.stageTimeouts[i]); updateTimes();
}
function onStageTimeout(i){
  if(state.stageElapsed[i]>0 || state.timedOut) return;
  state.timedOut=true;
  document.getElementById('timeoutTitle').textContent = `Stage Timed Out â€” ${["Upload","OCR","Parse","GeoJSON","Review","Redirect"][i]}`;
  document.getElementById('timeoutBackdrop').style.display='flex';
}

/* ======= GeoJSON: bbox-indexed lookup (fast) ======= */
function indexFC(fc){
  const items = (fc.features||[]).map(f => ({ f, b: turf.bbox(f) })); // [minX,minY,maxX,maxY]
  return { items };
}
function inBBox(pt, bb){ return pt[0] >= bb[0] && pt[0] <= bb[2] && pt[1] >= bb[1] && pt[1] <= bb[3]; }
function pipIndexed(idx, pt, key){
  if(!idx?.items) return "";
  const point = turf.point(pt);
  for(const {f,b} of idx.items){
    if(!inBBox(pt, b)) continue;
    if(turf.booleanPointInPolygon(point, f)) return f.properties?.[key] || f.properties?.name || "";
  }
  return "";
}
async function loadGeo(){
  const [w,b,p] = await Promise.all([
    fetch("./data/wards.geojson").then(r=>r.json()),
    fetch("./data/beats.geojson").then(r=>r.json()),
    fetch("./data/police_jurisdiction.geojson").then(r=>r.json())
  ]);
  state.gjIndex.wards  = indexFC(w);
  state.gjIndex.beats  = indexFC(b);
  state.gjIndex.police = indexFC(p);
}
function lookup(lat, lon){
  const pt=[parseFloat(lon), parseFloat(lat)];
  return {
    WARD:    pipIndexed(state.gjIndex.wards,  pt, "WARD"),
    BEAT_NO: pipIndexed(state.gjIndex.beats,  pt, "BEAT_NO"),
    PS_NAME: pipIndexed(state.gjIndex.police, pt, "PS_NAME")
  };
}

/* ======= Image utils ======= */
async function cropOverlay(dataURL){
  const blob=await (await fetch(dataURL)).blob();
  const bmp=await createImageBitmap(blob);
  const W=bmp.width, H=bmp.height;
  const cropY=Math.round(H*0.62);
  const cropH=Math.max(120, Math.round(H*0.38));
  const targetW=1200; const scale=Math.min(1, targetW/W);
  const outW=Math.round(W*scale), outH=Math.round(cropH*scale);
  const c=document.createElement('canvas'); c.width=outW; c.height=outH;
  const ctx=c.getContext('2d');
  ctx.drawImage(bmp,0,cropY,W,cropH,0,0,outW,outH);
  // grayscale & gentle binarize
  const img=ctx.getImageData(0,0,outW,outH); const d=img.data;
  for(let i=0;i<d.length;i+=4){ const y=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; const v=y>170?255:(y<60?0:y); d[i]=d[i+1]=d[i+2]=v; }
  ctx.putImageData(img,0,0);
  return c.toDataURL('image/png');
}

/* ======= Parsing (dynamic; no city hardcoding) ======= */
function parseAll(text){
  const raw = String(text || "")
    .replace(/\u00A0|\u2009|\u2002|\u2003/g, ' ')
    .replace(/[|Â·â€¢]+/g, ' ')
    .replace(/\s{2,}/g, ' ')
    .trim();

  const linesAll = raw.split(/\n+/).map(s => s.trim()).filter(Boolean);
  const isNoise = (s) => /(?:gps\s*map\s*camera|google|wind|humidity|pressure|temperature|km\/h|hpa|Â°c|\bjoey\b)/i.test(s);
  const looksTime = (s) => /\b\d{1,2}:\d{2}\s*(?:AM|PM)?\b/i.test(s);
  const looksDate = (s) => /\b\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}\b/.test(s);
  const looksLat = (s) => /\bLat(?:itude)?\b/i.test(s);
  const looksLon = (s) => /\bLon(?:g|gitude)\b/i.test(s);
  const isLatLonLine = (s) => looksLat(s) || looksLon(s);

  /* LAT/LON */
  let lat="", lon="";
  for (const s of linesAll) {
    if (looksLat(s)) { const m=s.replace(/[^\d.+\-]/g,' ').match(/[-+]?\d{1,2}(?:\.\d+)?/); if(m) lat = lat || m[0]; }
    if (looksLon(s)) { const m=s.replace(/[^\d.+\-]/g,' ').match(/[-+]?\d{1,3}(?:\.\d+)?/); if(m) lon = lon || m[0]; }
  }
  if(!(lat&&lon)){ const z=raw.match(/Lat(?:itude)?\s*[:=]?\s*([+-]?\d{1,2}(?:\.\d+)?)[^\d\-+]+Lon[g|gitude]*\s*[:=]?\s*([+-]?\d{1,3}(?:\.\d+)?)/i); if(z){lat=lat||z[1]; lon=lon||z[2];}}
  if(!(lat&&lon)){ const z=raw.match(/([+-]?\d{1,2}\.\d+)[,\s]+([+-]?\d{1,3}\.\d+)/); if(z){lat=lat||z[1]; lon=lon||z[2];}}

  /* DATE & TIME */
  let date="", time="";
  const toIsoDate = (s) => { const m=s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/); if(!m) return ""; let [_,d,mo,y]=m; if(y.length===2) y=(+y<50?"20"+y:"19"+y); return `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`; };
  const to24h = (s) => { s=s.trim().toUpperCase(); const m=s.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)?$/); if(!m) return ""; let h=+m[1], mi=m[2], ap=m[3]||""; if(ap==="PM"&&h<12) h+=12; if(ap==="AM"&&h===12) h=0; return `${String(h).padStart(2,'0')}:${mi}`; };
  const dt = raw.match(/(\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}).{0,6}(\d{1,2}:\d{2}\s*(?:AM|PM)?)/i);
  if (dt) { date = toIsoDate(dt[1]); time = to24h(dt[2]); }

  /* ADDRESS (dynamic, multi-line friendly) */
  let address="";
  let idxLatBlock = linesAll.findIndex(s => isLatLonLine(s));
  if (idxLatBlock < 0) idxLatBlock = linesAll.length;
  const looksAddressy = (s) => /[A-Za-z]/.test(s) && !isNoise(s) && !looksDate(s) && !looksTime(s) && !isLatLonLine(s) && (/,/.test(s) || s.split(/\s+/).filter(x=>x.length>=3).length>=3);
  const cand=[];
  for(let i=idxLatBlock-1; i>=0 && cand.length<3; i--){
    const s=linesAll[i];
    if(looksAddressy(s)) cand.unshift(s); else if(cand.length) break;
  }
  if(cand.length){ address = cand.join(', '); }
  else {
    const any = linesAll.filter(looksAddressy).sort((a,b)=>b.length-a.length)[0];
    if(any) address = any;
  }
  const pin = raw.match(/\b[1-9]\d{5}\b/);
  address = String(address || "")
    .replace(/\s{2,}/g,' ')
    .replace(/\s+,/g,', ')
    .replace(/,\s*,/g,', ')
    .replace(/\s+i\b$/,'')
    .trim();
  if(pin && !address.includes(pin[0])) address = address.replace(/(?:,\s*)?(India)\s*$/i, (m,$1)=>`, ${pin[0]}, ${$1}`);

  return { lat, lon, address, date, time };
}

/* ======= Redirect ======= */
function startRedirectCountdown(sec){
  clearInterval(state.countdownTimer);
  els.redirectNote.style.display='block';
  let left=sec;
  els.redirectNote.innerHTML = `All set. Redirecting to Google Form in <span class="countdown">${left}s</span>â€¦ <a href="#" id="cancelRedirect">Cancel</a>`;
  state.countdownTimer=setInterval(()=>{
    left-=1; const span=document.querySelector('.countdown'); if(span) span.textContent=left+'s';
    if(left<=0){ clearInterval(state.countdownTimer); window.location.href = buildPrefillURL(); }
  },1000);
  els.redirectNote.onclick=(e)=>{
    if(e.target && e.target.id==='cancelRedirect'){
      e.preventDefault(); clearInterval(state.countdownTimer);
      els.redirectNote.innerHTML = `<button id="openFormNow" class="btn">Open Google Form now</button>`;
      document.getElementById('openFormNow').onclick=()=>{ window.location.href = buildPrefillURL(); };
    }
  };
}

/* ======= Upload wiring ======= */
els.drop.addEventListener('click',()=>els.file.click());
els.drop.addEventListener('dragover',e=>{e.preventDefault(); els.drop.style.borderColor="#9ec5ff";});
els.drop.addEventListener('dragleave',()=>{els.drop.style.borderColor="#cfe0f3";});
els.drop.addEventListener('drop',e=>{e.preventDefault(); els.drop.style.borderColor="#cfe0f3"; const f=e.dataTransfer.files?.[0]; if(!f) return; runPipeline(f);});
els.file.addEventListener('change',e=>{const f=e.target.files?.[0]; if(!f) return; runPipeline(f);});

/* ======= Reset & modals ======= */
els.btnReset.addEventListener('click', ()=>location.reload());
document.getElementById('modalCancel').addEventListener('click', ()=>{ document.getElementById('modalBackdrop').style.display='none'; });
document.getElementById('modalReset').addEventListener('click', ()=>location.reload());
document.getElementById('timeoutRetry').addEventListener('click', ()=>location.reload());
document.getElementById('timeoutClose').addEventListener('click', ()=>{ document.getElementById('timeoutBackdrop').style.display='none'; });

/* ======= Pipeline ======= */
async function runPipeline(file){
  const myRun = ++state.activeRun;

  // Hide dropzone, show cards
  els.dropCard.style.display='none';
  els.originalCard.style.display='block';
  els.overlayCard.style.display='block';
  els.overlayWrap.style.display='block';

  // Stage 1 â€” Upload
  startStage(0); setStatus("Image loadingâ€¦", "ok");
  const reader=new FileReader();
  reader.onload=async()=>{
    if(myRun!==state.activeRun) return;
    const dataUrl=reader.result; els.originalImg.src=dataUrl;

    setStatus("Optimising imageâ€¦","warn");
    const cropped = await cropOverlay(dataUrl);
    if(myRun!==state.activeRun) return;
    endStage(0);

    // Stage 2 â€” OCR (v5 or fallback v4). Never pass workerPath; arrays for core/lang.
    startStage(1); setStatus("Running OCRâ€¦","warn");
    state.croppedUrl=cropped; els.overlayImg.src=state.croppedUrl; els.overlayScanner.style.display="block";

    async function ocrV5(){
      if(!window.Tesseract || !window.Tesseract.createWorker) throw new Error('v5 not ready');
      const cfgLabel = window.__OCR_VERSION__ || '';
      const cfg = /unpkg/i.test(cfgLabel) ? window.__OCR_CDNS__.v5_unp : window.__OCR_CDNS__.v5_jsd;
      const worker = await Tesseract.createWorker({ corePath: cfg.core, langPath: cfg.langs });
      await worker.loadLanguage('eng'); await worker.initialize('eng');
      await worker.setParameters({
        tessedit_pageseg_mode: 6,
        tessedit_char_whitelist: "0123456789:/.-,+() APMapmÂ°'\"IndiaMaharashtraMumbaiAndheriVersovaRoadRdWestEastNorthSouth",
        user_defined_dpi: "200"
      });
      const {data:{text}} = await worker.recognize(state.croppedUrl);
      await worker.terminate(); return text;
    }
    async function ocrV4(){
      if(!window.Tesseract?.recognize){
        await new Promise((res,rej)=>{const s=document.createElement('script'); s.src=window.__OCR_CDNS__.v4_jsd.lib+'?v=ok'; s.onload=res; s.onerror=rej; document.head.appendChild(s);});
      }
      const {data:{text}} = await Tesseract.recognize(state.croppedUrl, 'eng', {});
      return text;
    }

    let text="";
    try { text = await ocrV5(); }
    catch(e){
      console.warn('v5 OCR failed â†’ fallback to v4:', e);
      try { text = await ocrV4(); }
      catch(e2){ console.error('v4 OCR failed', e2); els.overlayScanner.style.display="none"; setStatus("OCR failed in both engines. Please Retry.","err"); onStageTimeout(1); return; }
    }
    els.overlayScanner.style.display="none"; endStage(1);

    // Stage 3 â€” Parse
    startStage(2); setStatus("Parsing extracted textâ€¦","warn");
    Object.assign(state.data, parseAll(text));
    renderIncremental(); endStage(2);

    // Stage 4 â€” GeoJSON (bbox-indexed, fast)
    startStage(3); setStatus("GeoJSON lookupâ€¦","warn");
    state.outside=false;
    let g={WARD:"",BEAT_NO:"",PS_NAME:""};
    if(state.data.lat && state.data.lon){
      g = lookup(state.data.lat, state.data.lon);
      Object.assign(state.data, {WARD:g.WARD, BEAT_NO:g.BEAT_NO, PS_NAME:g.PS_NAME});
      renderIncremental();
      if(!g.WARD) state.outside = true;
    } else state.outside=true;
    endStage(3);

    if(state.outside){
      setStatus("Outside MCGM Boundaries â€” Not allowed.","err");
      document.getElementById('modalBackdrop').style.display='flex';
      return;
    }

    // Stage 5 â€” Review
    startStage(4); setStatus("Ready. Review the results.","ok"); endStage(4);

    // Stage 6 â€” Redirect
    startStage(5); startRedirectCountdown(5);
  };
  reader.readAsDataURL(file);
}

/* ======= Bootstrap ======= */
(async ()=>{
  try{ await loadGeo(); setStatus("Maps loaded. Upload an image to begin.","ok"); }
  catch(e){ console.error(e); setStatus("Could not load GeoJSON (check /data/ paths).","err"); }
  updateTimes();
  document.getElementById('appVersion').textContent='v2025.08.17';
})();
</script>
</body>
</html>
